w1<-read.csv("output/finalrun4.csv")

library(dplyr)
numberinfected<-w1 %>% 
  group_by(ID) %>%
  summarise(numberinfectedmean=mean(numberinfected))

numberinfected

numberinfected$ID<-gsub("UVC_irl", "UVCirl", numberinfected$ID)
numberinfected$ID<-gsub("UVC_bcs", "UVCbcs", numberinfected$ID)
numberinfected$ID<-gsub("UVC_bcs", "UVCbcs", numberinfected$ID)
numberinfected$ID<-gsub("BASELINE", "BASELINE_BASELINE", numberinfected$ID)
numberinfected$ID<-gsub("PPE", "PPE_PPE", numberinfected$ID)


numberinfected$int<-stringr::str_split_fixed(numberinfected$ID, "_", 5)[,4]
numberinfected$infsta<-stringr::str_split_fixed(numberinfected$ID, "_", 5)[,5]



####
numberinfectedgroup<-numberinfected %>% filter(infsta=="extremelylow")
numberinfectedgroup$numberinfectedmeanperc<-(numberinfectedgroup$numberinfectedmean/max(numberinfectedgroup$numberinfectedmean))*100


#a<-"CEMRA_BASELINE_noint$|CEMRA_BASELINE_surgicalmask$|CEMRA_PPE_FFP2$|CEMRA_PPE_FFP3$|CEMRA_PPE_Airhood$|CEMRA_ENG_surgicalmask_freshair$|CEMRA_ENG_surgicalmask_UVC_bcs$|CEMRA_ENG_surgicalmask_VentHead$|CEMRA_ADM_surgicalmask_surfacedis$|CEMRA_ADM_surgicalmask_surfacedishandhygiene$"
#b<-c("CEMRA_BASELINE_noint","CEMRA_BASELINE_surgicalmask","CEMRA_ADM_surgicalmask_surfacedis","CEMRA_ADM_surgicalmask_surfacedishandhygiene","CEMRA_ENG_surgicalmask_freshair","CEMRA_ENG_surgicalmask_UVC_bcs","CEMRA_PPE_FFP2","CEMRA_PPE_FFP3","CEMRA_ENG_surgicalmask_VentHead", "CEMRA_PPE_Airhood")
#library(stringr)
#numberinfected<-numberinfected %>% filter(str_detect(ID,a))%>%
#  mutate(ID=factor(ID, levels=b))



ggplot(numberinfectedgroup, aes(x=reorder(ID,-numberinfectedmeanperc), y=numberinfectedmeanperc, fill=ID))+
  geom_bar(stat="identity")+
  theme(
    axis.title.x=element_blank(),
    axis.text.x = element_blank(), 
    axis.ticks = element_blank())+
  theme(text = element_text(size=16))+
  ylab("Relative percentage risk compared to 'no intervention' baseline")+
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10),)

numberinfected$changeperc<-100-numberinfected$numberinfectedmeanperc

w1$ID<-as.character(w1$ID)

#### PPE


numbinfplotter<-function(a,b, log){
  w3long<-w1 %>% 
    select(ID, numberinfected) %>%
    filter(str_detect(ID,a))%>%
    mutate(ID=factor(ID, levels=b))%>%
    mutate(lognumberinfected=(numberinfected))%>%
    pivot_longer(cols=c(lognumberinfected))
  
  
  if(log==F){
    library(ggplot2)
    d<-ggplot(w3long, aes(x=ID, y=value))+
      geom_violin()+
      facet_wrap(~ID, scales="free_x")+
      theme(
        axis.title.x=element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank())+
      theme(text = element_text(size=16))
    d + scale_y_continuous(trans='log10')+
    ylab("Risk per single patient patient care activity")
  }else{
    #options(scipen=10000)
    options(scipen = 0)
    library(ggplot2)
    w3long$value<-log(w3long$value)
    d<-ggplot(w3long, aes(x=ID, y=value, fill=ID))+
      geom_violin()+
      theme(
        axis.title.x=element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank())+
      theme(text = element_text(size=16))+
      ylab("Risk per single patient care activity")
  }
  d
}








